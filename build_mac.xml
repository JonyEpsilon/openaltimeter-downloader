<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="MacOS build" name="Build and deploy script">
	
	<property name="version" value="2.1.1.0"/>
	<property name="firmware_version" value="V8"/>
	
	<target name="Make version file">
		<tstamp>
		        <format property="builtat" pattern="MM/dd/yyyy hh:mm aa"/>
	    </tstamp>    
	    <propertyfile file="lib/version.properties"
	        comment="This file is automatically generated - DO NOT EDIT">        
	        <entry key="buildtime" value="${builtat}"/>
	        <entry key="version" value="${version}"/>
	    	<entry key="firmware_version" value="${firmware_version}"/>
	    </propertyfile>
	</target>


	<target name="MacOS build" depends="MacOS clean, Make version file" description="Build MacOS app">

		<mkdir dir="build/mac/downloader"/>
		<jar destfile="build/mac/downloader/downloader.jar">
			<manifest>
				<attribute name="Main-Class" value="org.openaltimeter.desktopapp.Controller"/>
				<attribute name="Class-Path" value=". RXTXcomm.jar jfreechart-1.0.13.jar jcommon-1.0.16.jar flexjson-2.0.jar icons.jar commons-math-2.2.jar"/>
			</manifest>
			<fileset dir="out/production/openaltimeter-downloader"/>
		</jar>

		<taskdef name="jarbundler"
		    classname="net.sourceforge.jarbundler.JarBundler"
			classpath="ant/jarbundler-2.2.0.jar"
		/>

		<jarbundler dir="build/mac/downloader" verbose="true" showPlist="false"
		                name="openaltimeter"
		                shortname="openaltimeter"
		                signature="OPAL"
		                mainclass="org.openaltimeter.desktopapp.Controller"
		                jvmversion="1.6+"
						icon="lib/logo_short_300.icns"
		                version="${version}"
		                infostring="openaltimeter"
		                bundleid="org.openaltimeter.desktopapp"  
						workingDirectory="$APP_PACKAGE/Contents/Resources/"
						jvmarchs="i386"
			>

			<jarfilelist dir="."
		files="build/mac/downloader/downloader.jar lib/RXTXcomm.jar lib/jfreechart-1.0.13.jar lib/jcommon-1.0.16.jar lib/flexjson-2.0.jar lib/icons.jar lib/commons-math-2.2.jar"/>

			<javaproperty name="apple.laf.useScreenMenuBar" value="true"/>
			<javaproperty name="apple.awt.brushMetal" value="true"/>
			<javaproperty name="apple.awt.showGrowBox" value="true"/>

		</jarbundler>

		<!-- JarBundler doesn't seem to quite offer the flexibility needed to do this -->
		<copy file="lib/rxtx_native/librxtxSerial.jnilib" todir="build/mac/downloader/openaltimeter.app/Contents/Resources/Java/"/>
		<copy todir="build/mac/downloader/openaltimeter.app/Contents/Resources/mac_flash">
			<fileset dir="lib/mac_flash"/>
		</copy>
		<copy todir="build/mac/downloader/openaltimeter.app/Contents/Resources/firmware">
			<fileset dir="lib/firmware"/>
		</copy>

		<copy file="lib/version.properties" todir="build/mac/downloader/openaltimeter.app/Contents/Resources/"/>

		<!-- need to make sure that avrdude is executable -->
		<chmod file="build/mac/downloader/openaltimeter.app/Contents/Resources/mac_flash/avrdude" perm="ugo+rx"/>
		
		<!-- copy in the docs, delete any build products, and make a zip -->
		<copy todir="build/mac/downloader/docs">
			<fileset dir="docs"/>
		</copy>	
		<delete file="build/mac/downloader/downloader.jar" />
		<exec dir="build/mac" command="zip -r openaltimeter_macos_${version}.zip downloader" />

	</target>

	<target name="MacOS clean">
		<delete dir="build/mac/downloader"/>
		<delete file="build/openaltimeter_macos_${version}.zip"/>
	</target>
	
	<target name="javadoc">
	<javadoc packagenames="org.openaltimeter.*"
	           sourcepath="src"
	           defaultexcludes="yes"
	           destdir="docs/javadoc"
	           use="true"
	           windowtitle="openaltimeter" />
	</target>
</project>
